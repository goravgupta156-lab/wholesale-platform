<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyqwdu9HZ-EoF2o8f8D7H_jsCQvLdXQ0fvGc7R58a7cfqZbMI51-Had_wPg-nds10aU/exec";
    const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/deimayg85/image/upload";
    const CLOUDINARY_PRESET = "rishu_preset";
    
    // ‡§´‡§æ‡§á‡§≤‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞
    window.fileStore = {};

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
    }

    function checkLogin() {
        const pass = document.getElementById('passInput').value;
        const pinBox = document.getElementById('pinInput');
        if (pass === "admin123") {
            pinBox.style.display = "block";
            if (pinBox.value === "1995") {
                document.getElementById('loginSection').style.display = "none";
                document.getElementById('sidebar').style.display = "flex";
                document.getElementById('mainView').style.display = "flex";
            }
        } else { alert("Wrong Password!"); }
    }

    function handleBulkUpload() {
        const files = document.getElementById('fileUpload').files;
        const tableBody = document.getElementById('productTableBody');
        const pct = document.getElementById('globalPct').value;

        for (let file of files) {
            // ‡§π‡§∞ ‡§∞‡•ã ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§Ø‡•Ç‡§®‡§ø‡§ï ‡§Ü‡§à‡§°‡•Ä ‡§¨‡§®‡§æ‡§è‡§Å
            let rowId = "ID_" + Math.random().toString(36).substr(2, 9);
            // ‡§´‡§æ‡§á‡§≤ ‡§ï‡•ã ‡§á‡§∏ ‡§Ü‡§à‡§°‡•Ä ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ï‡§∞‡•á‡§Ç
            window.fileStore[rowId] = file; 

            let parts = file.name.split('.')[0].split('_');
            
            let row = `
                <tr class="product-row" id="${rowId}">
                    <td><img src="${URL.createObjectURL(file)}" class="img-preview"></td>
                    <td><strong>${parts[0]}</strong><br><small>${parts[1] || ''}</small></td>
                    <td><input type="number" class="basic-rate" value="1000" oninput="calcRate(this)"></td>
                    <td class="cat-rate">${Math.round(1000 * (1 + pct/100))}</td>
                    <td><input type="number" class="weight" value="250"></td>
                    <td><input type="number" class="stock" value="21"></td>
                    <td><button onclick="document.getElementById('${rowId}').remove(); delete window.fileStore['${rowId}'];" style="color:red; background:none; border:none; cursor:pointer;">Remove</button></td>
                </tr>`;
            tableBody.insertAdjacentHTML('beforeend', row);
        }
    }

    function calcRate(input) {
        const pct = document.getElementById('globalPct').value;
        input.parentElement.nextElementSibling.innerText = Math.round(input.value * (1 + pct/100));
    }

    async function saveToGoogleSheets() {
        const rows = document.querySelectorAll('.product-row');
        if (rows.length === 0) return alert("Upload some products first!");

        const btn = document.getElementById('saveBtn');
        btn.innerText = "‚è≥ UPLOADING TO CLOUD...";
        btn.disabled = true;

        let productData = [];

        // ‡§è‡§ï-‡§è‡§ï ‡§ï‡§∞‡§ï‡•á ‡§π‡§∞ ‡§™‡•ç‡§∞‡•ã‡§°‡§ï‡•ç‡§ü ‡§ï‡•ã ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§ï‡§∞‡•á‡§Ç
        for (let row of rows) {
            let file = window.fileStore[row.id]; // ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§∏‡•á ‡§´‡§æ‡§á‡§≤ ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç
            let finalUrl = "https://via.placeholder.com/300?text=Upload+Failed";

            if (file) {
                let fd = new FormData();
                fd.append("file", file);
                fd.append("upload_preset", CLOUDINARY_PRESET);

                try {
                    // ‡§ï‡•ç‡§≤‡§æ‡§â‡§°‡§ø‡§®‡§∞‡•Ä ‡§™‡§∞ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç
                    const res = await fetch(CLOUDINARY_URL, { method: "POST", body: fd });
                    const data = await res.json();
                    
                    // ‡§Ö‡§ó‡§∞ ‡§Ö‡§∏‡§≤‡•Ä ‡§≤‡§ø‡§Ç‡§ï ‡§Æ‡§ø‡§≤ ‡§ó‡§Ø‡§æ, ‡§§‡•ã ‡§â‡§∏‡•á ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§Ç
                    if (data.secure_url) {
                        finalUrl = data.secure_url;
                        console.log("Upload Success:", finalUrl);
                    }
                } catch (err) { 
                    console.error("Cloudinary Upload Error:", err); 
                }
            }

            // ‡§Ö‡§¨ ‡§°‡•á‡§ü‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç (‡§Ö‡§∏‡§≤‡•Ä ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•á ‡§∏‡§æ‡§•)
            productData.push({
                action: "bulkUpload",
                name: row.cells[1].querySelector('strong').innerText,
                type: row.cells[1].querySelector('small').innerText,
                basicRate: row.querySelector('.basic-rate').value,
                catalogRate: row.querySelector('.cat-rate').innerText,
                weight: row.querySelector('.weight').value,
                stock: row.querySelector('.stock').value,
                imageUrl: finalUrl
            });
        }

        // ‡§Ö‡§¨ ‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§ó‡•Ç‡§ó‡§≤ ‡§∂‡•Ä‡§ü ‡§™‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç
        try {
            btn.innerText = "‚è≥ SAVING TO SHEET...";
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(productData) });
            alert("SUCCESS! Data & Real Images Synced.");
            document.getElementById('productTableBody').innerHTML = '';
            window.fileStore = {}; // ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ñ‡§æ‡§≤‡•Ä ‡§ï‡§∞‡•á‡§Ç
        } catch (e) { 
            alert("Error saving to sheet. Check internet."); 
        }

        btn.innerText = "üíæ SAVE ALL CHANGES";
        btn.disabled = false;
    }
</script>